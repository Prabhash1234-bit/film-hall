<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Seat Booking</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; }
    .seat { display: inline-block; width: 40px; height: 40px; margin: 4px; background-color: #ddd; line-height: 40px; cursor: pointer; }
    .selected { background-color: green; color: white; }
    .booked { background-color: red; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1 id="movieTitle">Loading...</h1>
  <p id="showtime"></p>
  <p id="price"></p>
  <div id="seats"></div>
  <button id="payBtn" style="margin-top:20px;">Pay & Book</button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // ‚úÖ Replace with your actual Firebase config
    const firebaseConfig = {
¬† apiKey: "AIzaSyCOEWNxz-PSgZd-iE19O8ykM4yCullRVAQ",
¬† authDomain: "film-hall-booking.firebaseapp.com",
¬† projectId: "film-hall-booking",
¬† storageBucket: "film-hall-booking.firebasestorage.app",
¬† messagingSenderId: "307732411395",
¬† appId: "1:307732411395:web:44377a6f4f30259e7c0a36",
¬† measurementId: "G-3HKF4JPPFT"
}; 

    // ‚úÖ Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const movieId = urlParams.get("id");
    const selectedShowtime = urlParams.get("show"); // e.g., 2PM

    let movieData = null;
    let selectedSeats = [];

    async function loadMovie() {
      const doc = await db.collection("movies").doc(movieId).get();
      movieData = doc.data();

      document.getElementById("movieTitle").innerText = movieData.title;
      document.getElementById("showtime").innerText = `Showtime: ${selectedShowtime}`;
      document.getElementById("price").innerText = `Price: ‚Çπ${movieData.price}`;

      // Booking lock: Disable booking if less than 2hrs before show
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const [timeStr, period] = selectedShowtime.match(/(\d+)(AM|PM)/i).slice(1);
      let hour = parseInt(timeStr);
      if (period === "PM" && hour !== 12) hour += 12;

      const showDateTime = new Date(tomorrow);
      showDateTime.setHours(hour, 0, 0);

      const now = new Date();
      const diff = (showDateTime - now) / (1000 * 60 * 60);

      if (now.getHours() < 12) {
        alert("Booking opens today at 12 PM");
        document.getElementById("payBtn").disabled = true;
        return;
      }

      if (diff < 2) {
        alert("Booking closed 2 hours before showtime.");
        document.getElementById("payBtn").disabled = true;
        return;
      }

      renderSeats();
    }

    function renderSeats() {
      const container = document.getElementById("seats");
      const booked = movieData.bookings?.[selectedShowtime] || [];

      for (let i = 1; i <= 100; i++) {
        const seat = i <= 50 ? `A${i}` : `B${i - 50}`;
        const div = document.createElement("div");
        div.className = "seat";
        div.innerText = seat;

        if (booked.includes(seat)) {
          div.classList.add("booked");
        }

        div.addEventListener("click", () => {
          if (div.classList.contains("booked")) return;

          div.classList.toggle("selected");
          const index = selectedSeats.indexOf(seat);
          if (index >= 0) selectedSeats.splice(index, 1);
          else selectedSeats.push(seat);
        });

        container.appendChild(div);
      }
    }

    document.getElementById("payBtn").onclick = async () => {
      if (selectedSeats.length === 0) return alert("Select at least one seat.");
      const total = movieData.price * selectedSeats.length;

      const razorpayOptions = {
        key: "rzp_test_GAiEEXi5SvLscR", // ‚úÖ Replace with your Razorpay key
        amount: total * 100,
        currency: "INR",
        name: "Film Hall",
        description: `Booking for ${movieData.title}`,
        handler: async function (response) {
          // Mark seats as booked
          const ref = db.collection("movies").doc(movieId);
          await db.runTransaction(async (tx) => {
            const snap = await tx.get(ref);
            const data = snap.data();
            const current = data.bookings?.[selectedShowtime] || [];
            const updated = [...new Set([...current, ...selectedSeats])];
            tx.update(ref, {
              [`bookings.${selectedShowtime}`]: updated
            });
          });

          generatePDF(movieData.title, selectedShowtime, selectedSeats, total);
        },
        theme: { color: "#3399cc" }
      };

      const rzp = new Razorpay(razorpayOptions);
      rzp.open();
    };

    function generatePDF(title, time, seats, price) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("üéüÔ∏è Film Hall Ticket", 20, 20);
      doc.setFontSize(12);
      doc.text(`Movie: ${title}`, 20, 40);
      doc.text(`Showtime: ${time}`, 20, 50);
      doc.text(`Seats: ${seats.join(", ")}`, 20, 60);
      doc.text(`Total: ‚Çπ${price}`, 20, 70);
      doc.save("ticket.pdf");
    }

    loadMovie();
  </script>
</body>
</html>
