<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Seat Booking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    h2 {
      margin-top: 0;
    }
    #movieDetails {
      margin-bottom: 20px;
    }
    .seat {
      width: 50px;
      height: 50px;
      margin: 5px;
      display: inline-block;
      text-align: center;
      line-height: 50px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .available { background-color: lightgreen; }
    .booked { background-color: lightgray; pointer-events: none; }
    .selected { background-color: orange; }
    #seatsContainer {
      max-width: 350px;
      margin: auto;
    }
    #payBtn {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="movieDetails">
    <h2 id="title">Loading...</h2>
    <p><strong>Showtime:</strong> <span id="showtime"></span></p>
    <p><strong>Price:</strong> ‚Çπ<span id="price"></span></p>
  </div>

  <div id="seatsContainer"></div>

  <button id="payBtn" style="display:none;">Pay & Download Ticket</button>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCOEWNxz-PSgZd-iE19O8ykM4yCullRVAQ",
      authDomain: "film-hall-booking.firebaseapp.com",
      projectId: "film-hall-booking",
      storageBucket: "film-hall-booking.appspot.com",
      messagingSenderId: "1034311788406",
      appId: "1:1034311788406:web:c6e196ab37d58584dc1860"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const urlParams = new URLSearchParams(window.location.search);
    const movieId = urlParams.get("id");
    const titleEl = document.getElementById("title");
    const showtimeEl = document.getElementById("showtime");
    const priceEl = document.getElementById("price");
    const seatsContainer = document.getElementById("seatsContainer");
    const payBtn = document.getElementById("payBtn");

    let selectedSeat = null;
    let seatPrice = 0;
    let ticketTitle = "";

    async function loadMovie() {
      if (!movieId) {
        titleEl.textContent = "Invalid Movie ID!";
        return;
      }

      const doc = await db.collection("movies").doc(movieId).get();
      if (!doc.exists) {
        titleEl.textContent = "Movie Not Found!";
        return;
      }

      const data = doc.data();
      const showtime = data.showtime;
      const price = data.price;
      ticketTitle = data.title;
      titleEl.textContent = ticketTitle;
      showtimeEl.textContent = showtime;
      priceEl.textContent = price;

      // Booking logic (lock 2 hours before)
      const now = new Date();
      const tomorrow = new Date(now);
      tomorrow.setDate(now.getDate() + 1);
      const showHour = parseInt(showtime.replace("AM", "").replace("PM", "")) + (showtime.includes("PM") && showtime !== "12PM" ? 12 : 0);
      const showDate = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), showHour, 0, 0);
      const lockTime = new Date(showDate.getTime() - 2 * 60 * 60 * 1000);

      if (now < new Date(now.getFullYear(), now.getMonth(), now.getDate(), 12)) {
        titleEl.textContent += " (Booking opens at 12PM today)";
        return;
      }

      if (now > lockTime) {
        titleEl.textContent += " (Booking closed)";
        return;
      }

      renderSeats(price);
    }

    function renderSeats(basePrice) {
      seatsContainer.innerHTML = "";
      for (let i = 1; i <= 100; i++) {
        const seat = document.createElement("div");
        seat.classList.add("seat", "available");
        seat.textContent = i <= 50 ? `A${i}` : `B${i - 50}`;
        seat.dataset.price = i <= 50 ? 50 : 100;
        seat.addEventListener("click", () => {
          document.querySelectorAll(".seat").forEach(s => s.classList.remove("selected"));
          seat.classList.add("selected");
          selectedSeat = seat.textContent;
          seatPrice = seat.dataset.price;
          payBtn.style.display = "block";
        });
        seatsContainer.appendChild(seat);
      }
    }

    payBtn.addEventListener("click", () => {
      if (!selectedSeat) return;

      const razorpayLink = seatPrice == 50 
        ? "https://rzp.io/rzp/Q3W64IW9" 
        : "https://rzp.io/rzp/nQryg1Y";

      window.open(razorpayLink, "_blank");

      // Wait 8 seconds then download ticket
      setTimeout(() => {
        const link = document.createElement("a");
        const ticketText = `
üé¨ ${ticketTitle}
üéüÔ∏è Seat: ${selectedSeat}
üïí Showtime: ${showtimeEl.textContent}
üí∞ Price: ‚Çπ${seatPrice}
‚úÖ Booking Confirmed
        `;
        const blob = new Blob([ticketText], { type: "text/plain" });
        link.href = URL.createObjectURL(blob);
        link.download = `${ticketTitle}_Ticket_${selectedSeat}.txt`;
        link.click();
      }, 8000);
    });

    loadMovie();
  </script>
</body>
</html>
